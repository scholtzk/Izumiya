<!DOCTYPE html>
<html>
<head>
    <title>Square Payment Callback</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f0f0f0;
        }
        .loading {
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="loading">Processing Square payment...</div>
    
    <script>
        // Get Square callback parameters
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        
        console.log('Square callback page loaded');
        console.log('URL:', window.location.href);
        console.log('Data param:', dataParam);
        
        if (dataParam) {
            try {
                // Parse Square callback data
                const transactionInfo = JSON.parse(decodeURIComponent(dataParam));
                console.log('Square callback data:', transactionInfo);
                
                // Check for success or error
                if (transactionInfo.error_code) {
                    // Error occurred
                    console.error('Square payment error:', transactionInfo.error_code);
                    // Try multiple redirect methods
                    setTimeout(() => {
                        window.location.href = 'prosurf://https://scholtzk.github.io/Izumiya/?square_error=' + encodeURIComponent(transactionInfo.error_code);
                    }, 100);
                    setTimeout(() => {
                        window.location.href = 'https://scholtzk.github.io/Izumiya/?square_error=' + encodeURIComponent(transactionInfo.error_code);
                    }, 1000);
                } else if (transactionInfo.transaction_id || transactionInfo.client_transaction_id) {
                    // Success
                    console.log('Square payment successful');
                    const transactionId = transactionInfo.transaction_id || transactionInfo.client_transaction_id;
                    // Try multiple redirect methods
                    setTimeout(() => {
                        window.location.href = 'prosurf://https://scholtzk.github.io/Izumiya/?square_success=1&transaction_id=' + encodeURIComponent(transactionId);
                    }, 100);
                    setTimeout(() => {
                        window.location.href = 'https://scholtzk.github.io/Izumiya/?square_success=1&transaction_id=' + encodeURIComponent(transactionId);
                    }, 1000);
                } else {
                    // Cancelled
                    console.log('Square payment cancelled');
                    setTimeout(() => {
                        window.location.href = 'prosurf://https://scholtzk.github.io/Izumiya/?square_cancelled=1';
                    }, 100);
                    setTimeout(() => {
                        window.location.href = 'https://scholtzk.github.io/Izumiya/?square_cancelled=1';
                    }, 1000);
                }
            } catch (error) {
                console.error('Error parsing Square callback:', error);
                setTimeout(() => {
                    window.location.href = 'prosurf://https://scholtzk.github.io/Izumiya/?square_error=parse_error';
                }, 100);
                setTimeout(() => {
                    window.location.href = 'https://scholtzk.github.io/Izumiya/?square_error=parse_error';
                }, 1000);
            }
        } else {
            // No data parameter, redirect to POS
            console.log('No data parameter, redirecting to POS');
            setTimeout(() => {
                window.location.href = 'prosurf://https://scholtzk.github.io/Izumiya/';
            }, 100);
            setTimeout(() => {
                window.location.href = 'https://scholtzk.github.io/Izumiya/';
            }, 1000);
        }
    </script>
</body>
</html>
